var quizData = [];
var numOfQuiz = 0;
var answerData=[];
var widthOfItem = 720;
var currentCard = 0;
var mbtiData = {'E':0, 'I':0, 'S':0, 'N':0, 'T':0, 'F':0, 'J':0,  'P':0};
var mbti = "";
var folder = "";

var slider = null;
var progressText = null;
var progressDiv = null;
var mainContents = null;
var progressBar = null;
var backButton = null;

/* =============== 각 값 가져오기 =============== */
function initElements()
{
	slider       = document.getElementById("qna_slider");
	progressText = document.getElementById("progressText");
	progressDiv  = document.getElementById("progressDiv");
	mainContents = document.getElementById("main_contents");
	progressBar  = document.getElementById("progressValue");
	backButton   = document.getElementById("prev_btn");
}

/* =============== url 파라미터 가져오기 =============== */
function getParameterByName(name)
{
	name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
	var regex = new RegExp(
		"[\\?&]" + name + "=([^&#]*)"),
		results = regex.exec(location.search);
		return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " ")
	);
}

/* =============== 파일 가져오기 =============== */
window.addEventListener('DOMContentLoaded', function(){
  folder = getParameterByName('folder');
  //alert(folder);
  
  var rawData = loadFile("../../testlist/" + folder + "/datas/quizData.txt");
  //var rawData = qdata;
  initElements();

  //init quizData & answerData & numOfQuiz
  var sentances = rawData.split('\n');
  for (var i =0; i<sentances.length; i++) {
    let text = sentances[i];
    if(text =='')
      continue;
    else if(text[0]=='#')  {
      quizData.push([text.slice(1)]);
      numOfQuiz++;
      answerData.push(-1);
    }
    else {
      quizData[numOfQuiz-1].push( [text.slice(1),text[0]]);
    }
  }
  //make all li's
  for(var i=0; i<quizData.length; i++)
  {
    var htmlData = "<li><div id=\"question\">"+
                      quizData[i][0]+"</div><div id = \"answer\">";
    for(var j=1; j<quizData[i].length; j++)
    {
    	htmlData +="<button class=\"answers\" id = \""+i+"_"+(j-1)+"\"onclick=\"answerSelected("+i+","+(j-1)+")\">"+quizData[i][j][0]+"</button>";
    }
    htmlData +="</div></li>";
    slider.innerHTML += htmlData;
  }
  slider.style.width = ""+ widthOfItem * (quizData.length) + "px";

  updateProgressBar();

});


/* =============== 진행 게이지 =============== */
function updateProgressBar()
{
  progressText.innerHTML = ""+(currentCard+1)+"/"+numOfQuiz;
  progressBar.style.width = ""+(100*(currentCard+1)/numOfQuiz)+"%";
}

/* =============== 문제 이동 =============== */
function moveSlider(dir)
{
  var player = slider.animate([
    {transform: "translate("+(currentCard * -widthOfItem)+"px,0px)"},
    {transform: "translate("+((currentCard+dir) * -widthOfItem)+"px,0px)"}
  ], {duration:360, easing:"ease-out"});
  player.addEventListener("finish",function(){
    slider.style.transform="translate("+((currentCard * -widthOfItem))+"px,0px)";
  });
  currentCard += dir;

  if(currentCard !=0 && currentCard != numOfQuiz)
  {
	  backButton.style.display = "block";
	  $('#exit_btn').css('display','none');
  }
  else
  {
	  backButton.style.display = "none";
	  $('#exit_btn').css('display','block');
  }

  if(currentCard == numOfQuiz)
  {
    progressText.innerHTML = "";
    mainContents.style.opacity = "0";
    setTimeout(finish,400);

    for(var i=0; i<answerData.length; i++)
    {
      mbtiData[ quizData[i][answerData[i]+1][1] ] ++;
    }
    mbti += compMBTI('E','I') + compMBTI('S','N') + compMBTI('T','F') + compMBTI('J','P');
    return;
  }
  updateProgressBar();
}

/* =============== 답 선택하기 =============== */
function answerSelected(question,answer)
{
  var but = document.getElementById(""+question+"_"+answerData[question]);
  if(question != currentCard) return;
  if(but != null)             but.classList.remove("selected");

  answerData[question] = answer;

  but = document.getElementById(""+question+"_"+answer);
  but.classList.add("selected");

  moveSlider(+1);

}

function compMBTI(a,b)
{
  if(mbtiData[a] > mbtiData[b])
    return a;
  else
    return b;
}

function finish(){
  window.location.href = "result.jsp?folder=" + folder + "#"+mbti;
}
